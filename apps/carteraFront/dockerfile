# Etapa 1: Build con dependencias completas
FROM node:20-alpine AS build

WORKDIR /app

# 1. Copia solo archivos de dependencias primero (mejor caché)
COPY package.json package-lock.json* ./

# 2. Forzar limpiar cache, evitar problemas de binarios
RUN npm cache clean --force

# 3. Instalar dependencias DENTRO del contenedor
RUN npm install

# 4. Copia el resto del código
COPY . .

# 5. Build del proyecto (ajusta el script según tu package.json)
RUN npm run build

# Etapa 2: Servir con Nginx
FROM nginx:alpine

# Limpia los archivos por defecto de nginx
RUN rm -rf /usr/share/nginx/html/*

# Copia el build del frontend
COPY --from=build /app/dist /usr/share/nginx/html

EXPOSE 80

# Mantén Nginx corriendo
CMD ["nginx", "-g", "daemon off;"]
